<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIDWW Sales Filter Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: block;
            width: 100%;
            padding: 60px 20px;
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-input-label.drag-over {
            border-color: #667eea;
            background: #e6fffa;
        }

        .file-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #a0aec0;
        }

        .file-text {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .file-subtext {
            font-size: 0.9rem;
            color: #718096;
        }

        .selected-file {
            margin-top: 15px;
            padding: 15px;
            background: #e6fffa;
            border-radius: 8px;
            border-left: 4px solid #38b2ac;
        }

        .selected-file-name {
            font-weight: 600;
            color: #2d3748;
        }

        .upload-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            margin-top: 30px;
            text-align: center;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .download-section {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: #f0fff4;
            border-radius: 12px;
            border: 1px solid #9ae6b4;
        }

        .download-link {
            display: inline-block;
            padding: 12px 30px;
            background: #38a169;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-link:hover {
            background: #2f855a;
            transform: translateY(-2px);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .alert-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }

        .hidden {
            display: none;
        }

        /* Navigation Tabs */
        .nav-tab {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: white;
            color: #667eea;
        }

        .nav-tab:hover {
            background: #edf2f7;
        }

        .tab-content {
            margin-top: 0;
        }

        /* History Section */
        .history-section {
            margin-top: 20px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-filename {
            font-weight: 600;
            color: #2d3748;
        }

        .history-date {
            color: #718096;
            font-size: 0.9rem;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-stats {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .history-download {
            padding: 8px 16px;
            background: #38a169;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .history-download:hover {
            background: #2f855a;
        }

        /* Statistics Section */
        .stats-section {
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-weight: 500;
        }

        .top-domains {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .top-domains h4 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .domain-item:last-child {
            border-bottom: none;
        }

        .domain-name {
            font-weight: 600;
            color: #4a5568;
        }

        .domain-stats {
            text-align: right;
            font-size: 0.9rem;
            color: #718096;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .file-input-label {
                padding: 40px 15px;
            }

            .file-icon {
                font-size: 2rem;
            }

            .file-text {
                font-size: 1rem;
            }

            .nav-tab {
                padding: 8px 12px;
                margin: 0 2px;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .history-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #4a5568;
        }

        /* Log Entry Styles */
        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .log-entry.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .log-entry.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .log-entry.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .log-timestamp {
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DIDWW Sales Filter</h1>
            <p>Upload your Excel file to score leads based on wholesale telecom customer profiles</p>
            
            <!-- Navigation Tabs -->
            <div style="margin-top: 20px;">
                <button id="uploadTab" class="nav-tab active">Upload File</button>
                <button id="historyTab" class="nav-tab">Processing History</button>
                <button id="statsTab" class="nav-tab">Statistics</button>
                <button id="logsTab" class="nav-tab">Logs</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Upload Section -->
        <div id="uploadSection" class="tab-content">
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx">
                    <label for="fileInput" class="file-input-label" id="fileLabel">
                        <div class="file-icon">📄</div>
                        <div class="file-text">Choose Excel file or drag here</div>
                        <div class="file-subtext">Only .xlsx files are supported</div>
                    </label>
                </div>

                <div id="selectedFile" class="selected-file hidden">
                    <div class="selected-file-name" id="selectedFileName"></div>
                </div>

                <button id="uploadBtn" class="upload-btn" disabled>Upload & Process</button>
            </div>

            <div id="statusSection" class="status-section hidden">
                <div class="spinner" id="spinner"></div>
                <div class="status-text" id="statusText">Processing...</div>
                <div id="progressBar" class="progress-bar-container hidden">
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="progressText" class="progress-text">0 / 0 rows processed</div>
                </div>
            </div>

            <div id="downloadSection" class="download-section hidden">
                <h3 style="margin-bottom: 15px; color: #2f855a;">✅ Processing Complete!</h3>
                <p style="margin-bottom: 15px; color: #4a5568;">Your scored leads file is ready for download.</p>
                <a href="http://localhost:5001/download" class="download-link" id="downloadLink">Download Result</a>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="tab-content hidden">
            <div class="history-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">Processing History</h3>
                <div id="historyList" class="history-list">
                    <div class="spinner" style="margin: 20px auto;"></div>
                    <div style="text-align: center; color: #718096;">Loading history...</div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statsSection" class="tab-content hidden">
            <div class="stats-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">Statistics Dashboard</h3>
                <div id="statsContent" class="stats-content">
                    <div class="spinner" style="margin: 20px auto;"></div>
                    <div style="text-align: center; color: #718096;">Loading statistics...</div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="tab-content hidden">
            <div class="logs-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">Processing Logs</h3>
                <div class="logs-controls" style="margin-bottom: 20px;">
                    <select id="sessionSelect" class="session-select" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        <option value="">Select a processing session...</option>
                    </select>
                    <button id="refreshLogsBtn" class="refresh-btn" style="margin-left: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Refresh</button>
                </div>
                <div id="logsContent" class="logs-content" style="max-height: 500px; overflow-y: auto; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                    <div style="text-align: center; color: #718096;">Select a session to view logs</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const selectedFile = document.getElementById('selectedFile');
        const selectedFileName = document.getElementById('selectedFileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusSection = document.getElementById('statusSection');
        const statusText = document.getElementById('statusText');
        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');
        const alertContainer = document.getElementById('alertContainer');

        // Tab elements
        const uploadTab = document.getElementById('uploadTab');
        const historyTab = document.getElementById('historyTab');
        const statsTab = document.getElementById('statsTab');
        const logsTab = document.getElementById('logsTab');
        const uploadSection = document.getElementById('uploadSection');
        const historySection = document.getElementById('historySection');
        const statsSection = document.getElementById('statsSection');
        const logsSection = document.getElementById('logsSection');

        // Progress elements
        const progressBarContainer = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressText = document.getElementById('progressText');

        // Tab navigation
        uploadTab.addEventListener('click', () => switchTab('upload'));
        historyTab.addEventListener('click', () => switchTab('history'));
        statsTab.addEventListener('click', () => switchTab('stats'));
        logsTab.addEventListener('click', () => switchTab('logs'));

        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Hide all sections
            uploadSection.classList.add('hidden');
            historySection.classList.add('hidden');
            statsSection.classList.add('hidden');
            logsSection.classList.add('hidden');
            
            // Show selected tab and section
            switch(tabName) {
                case 'upload':
                    uploadTab.classList.add('active');
                    uploadSection.classList.remove('hidden');
                    break;
                case 'history':
                    historyTab.classList.add('active');
                    historySection.classList.remove('hidden');
                    loadHistory();
                    break;
                case 'stats':
                    statsTab.classList.add('active');
                    statsSection.classList.remove('hidden');
                    loadStatistics();
                    break;
                case 'logs':
                    logsTab.classList.add('active');
                    logsSection.classList.remove('hidden');
                    loadSessions();
                    break;
            }
        }

        // Load processing history
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div><div style="text-align: center; color: #718096;">Loading history...</div>';

            try {
                const response = await fetch('http://localhost:5001/history');
                const result = await response.json();

                if (response.ok && result.sessions) {
                    if (result.sessions.length === 0) {
                        historyList.innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">No processing history found.</div>';
                        return;
                    }

                    historyList.innerHTML = result.sessions.map(session => `
                        <div class="history-item">
                            <div class="history-item-header">
                                <div class="history-filename">${session.filename}</div>
                                <div class="history-date">${new Date(session.upload_time).toLocaleString()}</div>
                            </div>
                            <div class="history-details">
                                <div class="history-stats">
                                    ${session.total_rows} rows processed • Status: ${session.status}
                                </div>
                                <a href="http://localhost:5001/history/${session.id}/download" class="history-download">Download</a>
                            </div>
                            <div class="history-verification" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                    <div style="background: #f0fff4; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: #38a169;">
                                            ${session.avg_score || 0}
                                        </div>
                                        <div style="font-size: 0.85em; color: #4a5568;">Average Score</div>
                                    </div>
                                    <div style="background: #f7fafc; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: ${session.domains_alive_count > 0 ? '#38a169' : '#e53e3e'};">
                                            ${session.domains_alive_count || 0}
                                        </div>
                                        <div style="font-size: 0.85em; color: #4a5568;">Domains Alive</div>
                                    </div>
                                    <div style="background: #ebf8ff; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: #3182ce;">
                                            ${session.linkedin_verified_count || 0}
                                        </div>
                                        <div style="font-size: 0.85em; color: #4a5568;">LinkedIn Verified</div>
                                    </div>
                                    <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: #0369a1;">
                                            ${session.facebook_verified_count || 0}
                                        </div>
                                        <div style="font-size: 0.85em; color: #4a5568;">Facebook Verified</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    throw new Error(result.error || 'Failed to load history');
                }
            } catch (error) {
                historyList.innerHTML = `<div style="text-align: center; color: #e53e3e; padding: 40px;">Error loading history: ${error.message}</div>`;
            }
        }

        // Load statistics
        async function loadStatistics() {
            const statsContent = document.getElementById('statsContent');
            statsContent.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div><div style="text-align: center; color: #718096;">Loading statistics...</div>';

            try {
                const response = await fetch('http://localhost:5001/stats');
                const result = await response.json();

                if (response.ok && result.stats) {
                    const stats = result.stats;
                    statsContent.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${stats.total_sessions}</div>
                                <div class="stat-label">Total Sessions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.total_leads_processed}</div>
                                <div class="stat-label">Leads Processed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.average_score}</div>
                                <div class="stat-label">Average Score</div>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h4 style="margin-bottom: 15px; color: #2d3748;">Verification Statistics</h4>
                            <div class="stats-grid">
                                <div class="stat-card" style="background: #f0fff4; border-color: #9ae6b4;">
                                    <div class="stat-number" style="color: #38a169;">${stats.domains_alive_count}</div>
                                    <div class="stat-label">Domains Alive</div>
                                    <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">${stats.domain_alive_rate}% success rate</div>
                                </div>
                                <div class="stat-card" style="background: #ebf8ff; border-color: #90cdf4;">
                                    <div class="stat-number" style="color: #3182ce;">${stats.linkedin_verified_count}</div>
                                    <div class="stat-label">LinkedIn Verified</div>
                                    <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">${stats.linkedin_verified_rate}% success rate</div>
                                </div>
                                <div class="stat-card" style="background: #f0f9ff; border-color: #7dd3fc;">
                                    <div class="stat-number" style="color: #0369a1;">${stats.facebook_verified_count}</div>
                                    <div class="stat-label">Facebook Verified</div>
                                    <div style="font-size: 0.85em; color: #4a5568; margin-top: 5px;">${stats.facebook_verified_rate}% success rate</div>
                                </div>
                            </div>
                        </div>
                        
                        ${stats.top_domains.length > 0 ? `
                        <div class="top-domains">
                            <h4>Top Domains</h4>
                            ${stats.top_domains.map(domain => `
                                <div class="domain-item">
                                    <div class="domain-name">${domain.domain}</div>
                                    <div class="domain-stats">
                                        ${domain.count} leads • Avg: ${domain.avg_score}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    `;
                } else {
                    throw new Error(result.error || 'Failed to load statistics');
                }
            } catch (error) {
                statsContent.innerHTML = `<div style="text-align: center; color: #e53e3e; padding: 40px;">Error loading statistics: ${error.message}</div>`;
            }
        }

        // File input change handler
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        // Drag and drop handlers
        fileLabel.addEventListener('dragover', function(e) {
            e.preventDefault();
            fileLabel.classList.add('drag-over');
        });

        fileLabel.addEventListener('dragleave', function(e) {
            e.preventDefault();
            fileLabel.classList.remove('drag-over');
        });

        fileLabel.addEventListener('drop', function(e) {
            e.preventDefault();
            fileLabel.classList.remove('drag-over');
            
            console.log('File drop event triggered');
            const files = e.dataTransfer.files;
            console.log(`Files dropped: ${files.length}`);
            
            if (files.length > 0) {
                const file = files[0];
                console.log(`Dropped file: ${file.name}, size: ${file.size} bytes, type: ${file.type}`);
                fileInput.files = files;
                handleFileSelection(file);
            }
        });

        function handleFileSelection(file) {
            console.log(`Handling file selection: ${file.name}`);
            
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showAlert('Please select an Excel (.xlsx) file only.', 'error');
                return;
            }

            // Check file size (limit to 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                showAlert('File size exceeds 10MB limit. Please use a smaller file.', 'error');
                console.error(`File too large: ${file.size} bytes`);
                return;
            }

            selectedFileName.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            selectedFile.classList.remove('hidden');
            uploadBtn.disabled = false;
            clearAlert();
        }

        // Upload button handler
        uploadBtn.addEventListener('click', function() {
            const file = fileInput.files[0];
            if (!file) {
                showAlert('Please select a file first.', 'error');
                return;
            }

            uploadFile(file);
        });

        // Load sessions for logs dropdown
        async function loadSessions() {
            const sessionSelect = document.getElementById('sessionSelect');
            console.log('loadSessions called, sessionSelect:', sessionSelect);
            
            try {
                const response = await fetch('http://localhost:5001/history');
                const result = await response.json();
                console.log('Sessions loaded:', result);
                
                if (response.ok && result.sessions) {
                    sessionSelect.innerHTML = '<option value="">Select a processing session...</option>';
                    console.log('Cleared dropdown, adding sessions...');
                    
                    result.sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.id;
                        option.textContent = `${session.filename} - ${new Date(session.upload_time).toLocaleString()}`;
                        sessionSelect.appendChild(option);
                        console.log('Added option:', option.textContent);
                    });
                    
                    console.log('Final dropdown options count:', sessionSelect.options.length);
                    
                    // Check if options persist after a delay
                    setTimeout(() => {
                        console.log('After 1 second - dropdown options count:', sessionSelect.options.length);
                        console.log('First option text:', sessionSelect.options[0]?.textContent);
                        console.log('Dropdown visibility:', window.getComputedStyle(sessionSelect).display);
                        console.log('Dropdown parent visibility:', window.getComputedStyle(sessionSelect.parentElement).display);
                    }, 1000);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Load logs for selected session
        async function loadLogs(sessionId) {
            const logsContent = document.getElementById('logsContent');
            
            if (!sessionId) {
                logsContent.innerHTML = '<div style="text-align: center; color: #718096;">Select a session to view logs</div>';
                return;
            }
            
            logsContent.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div><div style="text-align: center; color: #718096;">Loading logs...</div>';
            
            try {
                const response = await fetch(`http://localhost:5001/logs/${sessionId}`);
                const result = await response.json();
                
                if (response.ok && result.logs) {
                    if (result.logs.length === 0) {
                        logsContent.innerHTML = '<div style="text-align: center; color: #718096;">No logs found for this session</div>';
                        return;
                    }
                    
                    logsContent.innerHTML = result.logs.map(log => `
                        <div class="log-entry ${log.level}">
                            <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
                            ${log.message}
                            ${log.details ? `<div style="margin-top: 5px; font-size: 12px;">${log.details}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                logsContent.innerHTML = `<div style="text-align: center; color: #e53e3e;">Error loading logs: ${error.message}</div>`;
            }
        }

        // Session select change handler
        document.getElementById('sessionSelect').addEventListener('change', (e) => {
            loadLogs(e.target.value);
        });

        // Refresh logs button
        document.getElementById('refreshLogsBtn').addEventListener('click', () => {
            const sessionId = document.getElementById('sessionSelect').value;
            if (sessionId) {
                loadLogs(sessionId);
            }
        });

        // Connect to SSE for real-time progress updates
        function connectProgress(sessionId) {
            const eventSource = new EventSource(`http://localhost:5001/progress/stream/${sessionId}`);
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'connected') {
                    console.log('Connected to progress stream for session:', data.session_id);
                } else if (data.type === 'progress') {
                    updateProgress(data.data);
                } else if (data.type === 'log') {
                    console.log('Log:', data.data);
                } else if (data.type === 'complete') {
                    console.log('Processing complete');
                    eventSource.close();
                    onProcessingComplete();
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
                eventSource.close();
            };
            
            return eventSource;
        }

        // Update progress display
        function updateProgress(progress) {
            if (progress.total_rows > 0) {
                progressBarContainer.classList.remove('hidden');
                const percentage = (progress.current_row / progress.total_rows) * 100;
                progressBarFill.style.width = `${percentage}%`;
                progressText.textContent = `${progress.current_row} / ${progress.total_rows} rows processed`;
                
                if (progress.message) {
                    statusText.textContent = progress.message;
                }
            }
            
            // Check if processing is complete
            if (progress.current_step === 'completed') {
                onProcessingComplete();
            } else if (progress.current_step === 'failed') {
                onProcessingFailed(progress.message || 'Processing failed');
            }
        }
        
        // Handle processing completion
        function onProcessingComplete() {
            statusText.textContent = 'Processing complete!';
            setTimeout(() => {
                statusSection.classList.add('hidden');
                downloadSection.classList.remove('hidden');
                uploadBtn.disabled = false;
                showAlert('File processed successfully!', 'success');
            }, 1000);
        }
        
        // Handle processing failure
        function onProcessingFailed(errorMessage) {
            statusSection.classList.add('hidden');
            uploadBtn.disabled = false;
            showAlert(`Processing failed: ${errorMessage}`, 'error');
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Show processing status
            statusText.textContent = 'Uploading...';
            statusSection.classList.remove('hidden');
            uploadBtn.disabled = true;
            downloadSection.classList.add('hidden');
            clearAlert();

            // Reset progress bar
            progressBarContainer.classList.add('hidden');
            progressBarFill.style.width = '0%';

            // Add timeout controller
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                console.error('Upload timeout after 60 seconds');
            }, 60000); // 60 second timeout

            let eventSource = null;

            try {
                console.log(`Starting upload of file: ${file.name} (${file.size} bytes)`);
                
                const response = await fetch('http://localhost:5001/process', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log(`Response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Server error: ${errorText}`);
                    throw new Error(errorText || `Server error: ${response.status}`);
                }

                const result = await response.json();
                console.log('Processing result:', result);

                if (result.success && result.session_id) {
                    // Connect to progress stream immediately
                    statusText.textContent = 'Processing file...';
                    eventSource = connectProgress(result.session_id);
                    
                    // The SSE connection will handle completion/failure events
                } else {
                    throw new Error(result.error || 'Failed to start processing');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                if (eventSource) {
                    eventSource.close();
                }
                statusSection.classList.add('hidden');
                uploadBtn.disabled = false;
                
                if (error.name === 'AbortError') {
                    console.error('Upload timeout');
                    showAlert('Error: Upload timeout. The file may be too large or the server is not responding.', 'error');
                } else {
                    console.error('Upload error:', error);
                    showAlert(`Error: ${error.message || 'Unknown error occurred'}`, 'error');
                }
            }
        }

        function showAlert(message, type) {
            clearAlert();
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
        }

        function clearAlert() {
            alertContainer.innerHTML = '';
        }

        // Download link click handler
        downloadLink.addEventListener('click', function(e) {
            // Reset form after download
            setTimeout(() => {
                resetForm();
            }, 1000);
        });

        function resetForm() {
            fileInput.value = '';
            selectedFile.classList.add('hidden');
            uploadBtn.disabled = true;
            statusSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            clearAlert();
        }
    </script>
</body>
</html>